{"version":3,"file":"placement.min.js","sources":["../src/placement.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module to load and render the form for the CALL Learning placement module.\n *\n * @module     aiplacement_callextensions/placement\n * @copyright  2025 Laurent David <laurent@call-learning.fr>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport 'core/copy_to_clipboard';\nimport Notification from 'core/notification';\nimport {getString} from 'core/str';\nimport ModalForm from 'core_form/modalform';\nimport ModalDeleteCancel from 'core/modal_delete_cancel';\nimport Repository from \"./repository\";\nimport ModalEvents from 'core/modal_events';\nimport Templates from 'core/templates';\n\nconst CALLExtensionAssist = class {\n    /**\n     * The context ID.\n     * @type {Integer}\n     */\n    contextId;\n\n    /**\n     * The current action\n     * @type {String}\n     */\n    currentAction;\n\n    /**\n     * Progress interval.\n     */\n    progressInterval;\n\n    /**\n     * Constructor.\n     * @param {String} actionButtonSelector The selector for the action button.\n     */\n    constructor(actionButtonSelector) {\n        // Get the button by data-id attribute.\n        this.actionButton = document.querySelector(actionButtonSelector);\n        if (!this.actionButton) {\n            return;\n        }\n        this.contextId = this.actionButton.dataset.contextid ? parseInt(this.actionButton.dataset.contextid, 10) : 0;\n\n        this.registerEventListeners();\n    }\n\n    /**\n     * Register event listeners.\n     */\n    registerEventListeners() {\n        if (!this.actionButton) {\n            return;\n        }\n\n        this.actionButton.addEventListener('click', async (event) => {\n            event.preventDefault();\n            const isActive = await Repository.getActiveAction(this.contextId, 0);\n            if (!isActive || isActive.actionid) {\n                this.handleActionProgress(isActive.actionid);\n                return;\n            }\n            this.handleLaunchAction();\n        });\n    }\n\n    /**\n     * Handle form navigation for multi-step wizard.\n     */\n    async handleLaunchAction() {\n        const actionName = await getString(`action:${this.actionButton.dataset.actionName}`, 'aiplacement_callextensions');\n        const dialogTitle = await getString('actiondialog:title', 'aiplacement_callextensions', actionName);\n        const form = new ModalForm({\n            modalConfig: {\n                title: dialogTitle,\n            },\n            formClass: 'aiplacement_callextensions\\\\form\\\\mod_assist_action_form',\n            args: {\n                component: this.actionButton.dataset.component,\n                cmid: this.actionButton.dataset.cmid,\n                actionname: this.actionButton.dataset.actionName,\n            },\n            saveButtonText: await getString('submit'),\n        });\n\n        form.addEventListener(form.events.FORM_SUBMITTED, event => {\n            if (!event.detail.result) {\n                Notification.addNotification({\n                    type: 'info',\n                    message: event.detail.message\n                });\n            } else {\n                form.hide();\n                // Reload the page to show the new content.\n                window.location.reload();\n            }\n        });\n        form.show();\n    }\n\n    /**\n     * Handle an action already in progress.\n     * @param {Number} actionId The action id.\n     */\n    async handleActionProgress(actionId) {\n        // Create a modal to show the progress.\n        const actionName = await getString(`action:${this.actionButton.dataset.actionName}`, 'aiplacement_callextensions');\n        const modal = await ModalDeleteCancel.create({\n            title: getString('actiondialog:status', 'aiplacement_callextensions', actionName),\n            large: true,\n        });\n        const updateBody = (modal, actionId) => {\n            return Repository.actionStatus(actionId).then(async (action) => {\n                if (!action || action.status === 3) {\n                    modal.hide();\n                    modal.destroy(); // Destroy the modal.\n                    Notification.addNotification({\n                        type: 'failure',\n                        message: await getString('actiondialog:statuscheckfailure', 'aiplacement_callextensions')\n                    });\n                    clearInterval(this.progressInterval);\n                } else {\n                    if (action.status === 1 || action.status === 2) {\n                        modal.hide();\n                        modal.destroy();\n                        Notification.addNotification({\n                            type: 'failure',\n                            message: await getString('actiondialog:statuscheckfailure', 'aiplacement_callextensions')\n                        });\n                        clearInterval(this.progressInterval);\n                    } else {\n                        const content = Templates.renderForPromise('aiplacement_callextensions/progress', action);\n                        modal.setBodyContent(content);\n                    }\n                }\n            }).catch(Notification.exception);\n        };\n        modal.getRoot().on(ModalEvents.delete, () => {\n            clearInterval(this.progressInterval);\n            Repository.cancelAction(actionId).then(async () => {\n                modal.hide();\n                modal.destroy(); // Destroy the modal.\n                Notification.addNotification({\n                    type: 'success',\n                    message: await getString('actiondialog:cancelled', 'aiplacement_callextensions', actionName)\n                });\n            }).catch(Notification.exception);\n        });\n        modal.setDeleteButtonText(await getString('actiondialog:cancel', 'aiplacement_callextensions'));\n        // Initial body update.\n        await updateBody(modal, actionId);\n        const refreshHandler = () =>\n            updateBody(modal, actionId).then((shouldContinue) => !shouldContinue && clearInterval(this.progressInterval));\n        // Refresh the progress every 5 seconds.\n        this.progressInterval = setInterval(refreshHandler, 5000);\n\n        modal.show();\n    }\n};\n\nexport default CALLExtensionAssist;\n"],"names":["constructor","actionButtonSelector","actionButton","document","querySelector","this","contextId","dataset","contextid","parseInt","registerEventListeners","addEventListener","async","event","preventDefault","isActive","Repository","getActiveAction","actionid","handleLaunchAction","handleActionProgress","actionName","dialogTitle","form","ModalForm","modalConfig","title","formClass","args","component","cmid","actionname","saveButtonText","events","FORM_SUBMITTED","detail","result","hide","window","location","reload","addNotification","type","message","show","actionId","modal","ModalDeleteCancel","create","large","updateBody","actionStatus","then","action","status","destroy","clearInterval","progressInterval","content","Templates","renderForPromise","setBodyContent","catch","Notification","exception","getRoot","on","ModalEvents","delete","cancelAction","setDeleteButtonText","setInterval","shouldContinue"],"mappings":"+9BAgC4B,MAsBxBA,YAAYC,iKAEHC,aAAeC,SAASC,cAAcH,sBACtCI,KAAKH,oBAGLI,UAAYD,KAAKH,aAAaK,QAAQC,UAAYC,SAASJ,KAAKH,aAAaK,QAAQC,UAAW,IAAM,OAEtGE,0BAMTA,yBACSL,KAAKH,mBAILA,aAAaS,iBAAiB,SAASC,MAAAA,QACxCC,MAAMC,uBACAC,eAAiBC,oBAAWC,gBAAgBZ,KAAKC,UAAW,GAC7DS,WAAYA,SAASG,cAIrBC,0BAHIC,qBAAqBL,SAASG,8CAWrCG,iBAAmB,mCAAoBhB,KAAKH,aAAaK,QAAQc,YAAc,8BAC/EC,kBAAoB,kBAAU,qBAAsB,6BAA8BD,YAClFE,KAAO,IAAIC,mBAAU,CACvBC,YAAa,CACTC,MAAOJ,aAEXK,UAAW,2DACXC,KAAM,CACFC,UAAWxB,KAAKH,aAAaK,QAAQsB,UACrCC,KAAMzB,KAAKH,aAAaK,QAAQuB,KAChCC,WAAY1B,KAAKH,aAAaK,QAAQc,YAE1CW,qBAAsB,kBAAU,YAGpCT,KAAKZ,iBAAiBY,KAAKU,OAAOC,gBAAgBrB,QACzCA,MAAMsB,OAAOC,QAMdb,KAAKc,OAELC,OAAOC,SAASC,gCAPHC,gBAAgB,CACzBC,KAAM,OACNC,QAAS9B,MAAMsB,OAAOQ,aAQlCpB,KAAKqB,kCAOkBC,gBAEjBxB,iBAAmB,mCAAoBhB,KAAKH,aAAaK,QAAQc,YAAc,8BAC/EyB,YAAcC,6BAAkBC,OAAO,CACzCtB,OAAO,kBAAU,sBAAuB,6BAA8BL,YACtE4B,OAAO,IAELC,WAAa,CAACJ,MAAOD,WAChB7B,oBAAWmC,aAAaN,UAAUO,MAAKxC,MAAAA,YACrCyC,QAA4B,IAAlBA,OAAOC,UASI,IAAlBD,OAAOC,QAAkC,IAAlBD,OAAOC,OAC9BR,MAAMT,OACNS,MAAMS,gCACOd,gBAAgB,CACzBC,KAAM,UACNC,cAAe,kBAAU,kCAAmC,gCAEhEa,cAAcnD,KAAKoD,sBAChB,OACGC,QAAUC,mBAAUC,iBAAiB,sCAAuCP,QAClFP,MAAMe,eAAeH,cAlBzBZ,MAAMT,OACNS,MAAMS,gCACOd,gBAAgB,CACzBC,KAAM,UACNC,cAAe,kBAAU,kCAAmC,gCAEhEa,cAAcnD,KAAKoD,qBAexBK,MAAMC,sBAAaC,WAE1BlB,MAAMmB,UAAUC,GAAGC,sBAAYC,QAAQ,KACnCZ,cAAcnD,KAAKoD,sCACRY,aAAaxB,UAAUO,MAAKxC,UACnCkC,MAAMT,OACNS,MAAMS,gCACOd,gBAAgB,CACzBC,KAAM,UACNC,cAAe,kBAAU,yBAA0B,6BAA8BtB,iBAEtFyC,MAAMC,sBAAaC,cAE1BlB,MAAMwB,0BAA0B,kBAAU,sBAAuB,qCAE3DpB,WAAWJ,MAAOD,eAInBY,iBAAmBc,aAHD,IACnBrB,WAAWJ,MAAOD,UAAUO,MAAMoB,iBAAoBA,gBAAkBhB,cAAcnD,KAAKoD,qBAE3C,KAEpDX,MAAMF"}